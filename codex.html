<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex K-12: Serverless MVP</title>
    
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #282c34; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Header */
        header { background: #20232a; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #3e4451; }
        .logo { font-weight: bold; font-size: 22px; color: #61dafb; }
        .status { font-size: 14px; color: #aaa; }

        /* Main Layout */
        #workspace { display: flex; flex: 1; height: calc(100vh - 60px); }
        
        #blocklyArea { width: 60%; position: relative; }
        #blocklyDiv { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        #outputArea { width: 40%; display: flex; flex-direction: column; border-left: 1px solid #3e4451; background: #1e1e1e; }
        
        /* Code Preview */
        .panel-header { background: #252526; padding: 10px; font-size: 14px; font-weight: bold; color: #ccc; border-bottom: 1px solid #3e4451; }
        #code-display { flex: 1; padding: 15px; font-family: 'Consolas', monospace; color: #dcdcaa; white-space: pre-wrap; overflow: auto; border-bottom: 1px solid #3e4451; }

        /* Console Output */
        #console { flex: 1; padding: 15px; font-family: 'Consolas', monospace; background: #000; color: #fff; overflow: auto; }
        .success { color: #4caf50; }
        .error { color: #f44336; }

        /* Run Button */
        #run-btn { 
            margin: 10px; padding: 12px; background: #007acc; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; 
        }
        #run-btn:hover { background: #005f9e; }

    </style>
</head>
<body>

<header>
    <div class="logo">‚ö° Codex Serverless</div>
    <div class="status">Running in Browser Mode (Client-Side)</div>
</header>

<div id="workspace">
    <div id="blocklyArea">
        <div id="blocklyDiv"></div>
    </div>

    <div id="outputArea">
        <div class="panel-header">üêç Python Code (Generated Live)</div>
        <div id="code-display"># Your code will appear here...</div>
        
        <button id="run-btn" onclick="runCode()">‚ñ∂ Run Code</button>
        
        <div class="panel-header">üì∫ Output Console</div>
        <div id="console">Ready...</div>
    </div>
</div>

<xml id="toolbox" style="display: none">
    <category name="Loops" colour="120">
        <block type="controls_repeat_ext">
            <value name="TIMES"><shadow type="math_number"><field name="NUM">5</field></shadow></value>
        </block>
        <block type="controls_whileUntil"></block>
    </category>
    <category name="Logic" colour="210">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
    </category>
    <category name="Math" colour="230">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
    </category>
    <category name="Text" colour="160">
        <block type="text"></block>
        <block type="text_print"></block>
    </category>
</xml>

<script>
    // 1. Setup Blockly
    var blocklyArea = document.getElementById('blocklyArea');
    var blocklyDiv = document.getElementById('blocklyDiv');
    
    var workspace = Blockly.inject(blocklyDiv, {
        toolbox: document.getElementById('toolbox'),
        scrollbars: true,
        trashcan: true,
        theme: Blockly.Themes.Dark // Dark mode for "Hacker" feel
    });

    // Resize logic
    window.addEventListener('resize', function() {
        Blockly.svgResize(workspace);
    }, false);

    // 2. Generate Python Code
    function myUpdateFunction(event) {
        var code = Blockly.Python.workspaceToCode(workspace);
        document.getElementById('code-display').textContent = code || "# Drag blocks to generate code...";
    }
    workspace.addChangeListener(myUpdateFunction);

    // 3. Run Code using Skulpt (Client-Side Python Engine)
    function runCode() {
        var prog = Blockly.Python.workspaceToCode(workspace);
        var consoleDiv = document.getElementById("console");
        consoleDiv.innerHTML = ""; // Clear previous output

        Sk.pre = "console";
        Sk.configure({
            output: function(text) { 
                consoleDiv.innerHTML += text + "<br>"; 
            },
            read: function(x) {
                if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                    throw "File not found: '" + x + "'";
                return Sk.builtinFiles["files"][x];
            }
        });

        var myPromise = Sk.misceval.asyncToPromise(function() {
            return Sk.importMainWithBody("<stdin>", false, prog, true);
        });

        myPromise.then(function(mod) {
            consoleDiv.innerHTML += "<span class='success'>‚úî Execution Complete</span>";
        }, function(err) {
            consoleDiv.innerHTML += "<span class='error'>‚úñ Error: " + err.toString() + "</span>";
        });
    }
</script>

</body>
</html>